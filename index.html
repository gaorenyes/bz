<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>智能排盘</title>
  <style>
  *{margin:0;padding:0;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box;outline:none}
  html{font-size:18px;font-family:"Microsoft Yahei","Helvetica Neue",Helvetica,Arial,sans-serif;font-style:normal;}
  body{background-color:#eef7f2;padding:5px;}
  h1{font-size:28px;font-weight:normal;color:#0a0a0a;border-bottom:1px solid #373737;padding:5px 0;}
  #input{margin-top:5px;font-size:18px;float:left;width:360px;height:120px;padding:5px;}
  .condition{float:left;padding:5px;}
  .error{border-color:red}
  table{margin:2px;clear:both;display:block;border-collapse:collapse;empty-cells:show;border:0;}
  td{padding:4px;text-align:center;white-space:nowrap;}
  td.left{text-align:left;}
  td.bazi{font-size:22px;font-weight:bold;}
  td.bold{font-weight:bold;}
  td.small{font-size:14px;}
  .tip{clear:both;margin-top:10px;font-size:13px;color:#373737;white-space:normal;}
  .red{color:#c40000;}
  @media (max-width: 900px) {
    html{font-size:calc(100vw/7.5);}
    body{padding:0.05rem;}
    h1{font-size:0.32rem;}
    #input{width:100%;height:1rem;padding:0.1rem;font-size:0.36rem;}
    .condition{padding:0.2rem;font-size:0.28rem;}
    td{padding:0.04rem;font-size:0.28rem;}
    td.bazi{font-size:0.34rem;}
    td.small{font-size:0.21rem;}
    td.hide{font-size:0;width:0;padding:0;}
    .tip{margin-top:0.1rem;font-size:0.24rem;}
  }
  </style>
</head>
<body>
  <h1>八字排盘 - 智能排盘</h1>
  <textarea id="input"></textarea>
  <div class="condition">
    <label><input id="gender_man" type="radio" name="gender" value="+" checked>男</label>
    <label><input id="gender_woman" type="radio" name="gender" value="-">女</label>
    <label><input type="checkbox" id="lunar">阴历</label>
    <div class="tip">录入一段日期信息到框中，如199908121700-，代表1999年8月12日17点生女。<br>1. +表示男，-表示女。<br>2. 三个连续空格表示阴历。<br>3. 月前有空格表示闰月，非闰月不生效。<br>4. 时间跨度支持：1901-01-01(庚子年)至2099-12-31(己未年)。 </div>
  </div>
  
  <div id="pan"></div>
<script src="lunar.js"></script>
<script>
(function(W,D){
  var setClass = function(el,v){
    try{
      el.className = v;
    }catch(e){
      el.setAttribute('class', v);
    }
  };
  var trim = function(s){
    return s.replace(/(^\s*)|(\s*$)/g, '');
　};
  var padding = function(n){
    return (n<10?'0':'') + n;
  };
  var input = D.getElementById('input');
  var genderMan = D.getElementById('gender_man');
  var genderWoman = D.getElementById('gender_woman');
  var lunarCheck = D.getElementById('lunar');
  var result = D.getElementById('pan');
  
  var onChangeGender = function(){
    var v = input.value;
    var gender = genderMan.checked ? '+' : '-';
    if(/[+-]$/.test(v)){
      v = v.replace(/[+-]/g, gender);
    }else{
      v = v + gender;
    }
    input.value = v;
    onInput();
  };
  
  var onChangeLunar = function(){
    var v = input.value;
    if(/\s{3}/.test(v)){
      v = v.replace(/\s{3}/g, '');
    }else{
      v = '   '+v;
    }
    input.value = v;
    onInput();
  };
  
  var onInput = function(){
    var v = input.value;
    if(!/^\s*\d{4}\s*\d{2}\s*\d{2}\s*\d{2}\s*\d{2}\s*[+-]?$/.test(v)){
      setClass(input,'error');
      return;
    }
    lunarCheck.checked = /\s{3}/.test(v) ? 'checked' : '';
    setClass(input,'');
    compute();
  };
  
  var CHANG_SHENG_OFFSET = {'甲':1,'丙':10,'戊':10,'庚':7,'壬':4,'乙':6,'丁':9,'己':9,'辛':0,'癸':3};
  function getChangSheng(gan, ganIndex, zhiIndex){
    var offset = CHANG_SHENG_OFFSET[gan];
    var index = offset + (ganIndex%2==0?zhiIndex:-zhiIndex);
    if(index>=12){
      index -= 12;
    }
    if(index<0){
      index += 12;
    }
    return EightChar.CHANG_SHENG[index];
  }
  function getGanIndex(gan){
    for(var i=0,j=LunarUtil.GAN.length;i<j;i++){
      if(gan===LunarUtil.GAN[i]){
        return i-1;
      }
    }
    return 0;
  }
  function getZhiIndex(zhi){
    for(var i=0,j=LunarUtil.ZHI.length;i<j;i++){
      if(zhi===LunarUtil.ZHI[i]){
        return i-1;
      }
    }
    return 0;
  }
  
  var computeEightChar = function(lunar,solar,gender){
    var bazi = lunar.getEightChar();
    var currentYear,startYunSolar,daYun,daYunSize,currentYun;
    if(-1!=gender){
      var date = new Date();
      currentYear = date.getFullYear();
      var yun = bazi.getYun(gender);
      startYunSolar = yun.getStartSolar();
      daYun = yun.getDaYun();
      daYunSize = daYun.length;
      var currentLunar = Lunar.fromDate(date);
      
      var yZhi = currentLunar.getYearZhiByLiChun();
      var yHideGan = LunarUtil.ZHI_HIDE_GAN[yZhi];
      var yShiShenZhi = [];
      for(var u=0,v=yHideGan.length;u<v;u++){
        yShiShenZhi.push(yHideGan[u]+'-'+LunarUtil.SHI_SHEN_ZHI[bazi.getDayGan()+yZhi+yHideGan[u]]);
      }
      
      var mZhi = currentLunar.getMonthZhi();
      var mHideGan = LunarUtil.ZHI_HIDE_GAN[mZhi];
      var mShiShenZhi = [];
      for(var u=0,v=mHideGan.length;u<v;u++){
        mShiShenZhi.push(mHideGan[u]+'-'+LunarUtil.SHI_SHEN_ZHI[bazi.getDayGan()+mZhi+mHideGan[u]]);
      }
      
      var rZhi = currentLunar.getDayZhi();
      var rHideGan = LunarUtil.ZHI_HIDE_GAN[rZhi];
      var rShiShenZhi = [];
      for(var u=0,v=rHideGan.length;u<v;u++){
        rShiShenZhi.push(rHideGan[u]+'-'+LunarUtil.SHI_SHEN_ZHI[bazi.getDayGan()+rZhi+rHideGan[u]]);
      }
      currentYun = {
        daYunWuXing: '',
        liuNianWuXing: LunarUtil.WU_XING_GAN[currentLunar.getYearGanByLiChun()] + LunarUtil.WU_XING_ZHI[currentLunar.getYearZhiByLiChun()],
        liuYueWuXing: LunarUtil.WU_XING_GAN[currentLunar.getMonthGan()] + LunarUtil.WU_XING_ZHI[currentLunar.getMonthZhi()],
        daYunDiShi: '',
        liuNianDiShi: getChangSheng(bazi.getDayGan(), bazi.getDayGanIndex(), currentLunar.getYearZhiIndexByLiChun()),
        liuYueDiShi: getChangSheng(bazi.getDayGan(), bazi.getDayGanIndex(), currentLunar.getMonthZhiIndex()),
        daYunChangSheng: '',
        liuNianChangSheng: getChangSheng(currentLunar.getYearGanByLiChun(), currentLunar.getYearGanIndexByLiChun(), currentLunar.getYearZhiIndexByLiChun()),
        liuYueChangSheng: getChangSheng(currentLunar.getMonthGan(), currentLunar.getMonthGanIndex(), currentLunar.getMonthZhiIndex()),
        daYunXunKong: '',
        liuNianXunKong: LunarUtil.getXunKong(currentLunar.getYearInGanZhiByLiChun()),
        liuYueXunKong: LunarUtil.getXunKong(currentLunar.getMonthInGanZhi()),
        daYunNaYin: '',
        liuNianNaYin: LunarUtil.NAYIN[currentLunar.getYearInGanZhiByLiChun()],
        liuYueNaYin: LunarUtil.NAYIN[currentLunar.getMonthInGanZhi()],
        
        daYunShiShen:'',
        daYunShiShenZhi:[],
        liuNianGanZhi:currentLunar.getYearInGanZhiByLiChun(),
        liuNianShiShen:LunarUtil.SHI_SHEN_GAN[bazi.getDayGan() + currentLunar.getYearGanByLiChun()],
        liuNianShiShenZhi:yShiShenZhi,
        liuYueGanZhi:currentLunar.getMonthInGanZhi(),
        liuYueShiShen:LunarUtil.SHI_SHEN_GAN[bazi.getDayGan() + currentLunar.getMonthGan()],
        liuYueShiShenZhi:mShiShenZhi,
        liuRiGanZhi:currentLunar.getDayInGanZhi(),
        liuRiShiShen:LunarUtil.SHI_SHEN_GAN[bazi.getDayGan() + currentLunar.getDayGan()],
        liuRiShiShenZhi:rShiShenZhi
      };
      currentYun.liuNianGan = currentYun.liuNianGanZhi.substr(0,1);
      currentYun.liuNianZhi = currentYun.liuNianGanZhi.substr(1);
      
      currentYun.liuYueGan = currentYun.liuYueGanZhi.substr(0,1);
      currentYun.liuYueZhi = currentYun.liuYueGanZhi.substr(1);
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        if(d.getStartYear()<=currentYear&&currentYear<=d.getEndYear()){
          var gz = d.getGanZhi();
          if(gz){
            var g = gz.substr(0,1);
            var z = gz.substr(1);
            var zIndex = getZhiIndex(z);
            currentYun.daYunWuXing = LunarUtil.WU_XING_GAN[g] + LunarUtil.WU_XING_ZHI[z];
            currentYun.daYunDiShi = getChangSheng(bazi.getDayGan(), bazi.getDayGanIndex(), zIndex);
            currentYun.daYunChangSheng = getChangSheng(g, getGanIndex(g), zIndex);
            currentYun.daYunXunKong = LunarUtil.getXunKong(gz);
            currentYun.daYunNaYin = LunarUtil.NAYIN[gz];
            
            currentYun.daYunGan = g;
            currentYun.daYunZhi = z;
            currentYun.daYunGanZhi = gz;
            currentYun.daYunShiShen = LunarUtil.SHI_SHEN_GAN[bazi.getDayGan() + g];
            var dHideGan = LunarUtil.ZHI_HIDE_GAN[z];
            var dShiShenZhi = [];
            for(var x=0,y=dHideGan.length;x<y;x++){
              dShiShenZhi.push(dHideGan[x]+'-'+LunarUtil.SHI_SHEN_ZHI[bazi.getDayGan()+z+dHideGan[x]]);
            }
            currentYun.daYunShiShenZhi = dShiShenZhi;
          }
          break;
        }
      }
    }
    var s = '<table><tbody>';
    s += '<tr>';
    s += '<td>出生：</td>';
    s += '<td colspan="10" class="left small">' + solar.getYear() + '年' + solar.getMonth() + '月' + solar.getDay() + '日(' + lunar.getMonthInChinese() + '月' + lunar.getDayInChinese() + ')' + padding(solar.getHour()) + ':' + padding(solar.getMinute()) +' 星期'+solar.getWeekInChinese() + '生肖' + lunar.getYearShengXiao() + solar.getXingZuo()+'座</td>';
    s += '</tr>';
    
    s += '<tr>';
    s += '<td>节气：</td>';
    var prevJieQi = lunar.getPrevJie();
    var jieQiSolar = prevJieQi.getSolar();
    s += '<td colspan="10" class="left small">' + prevJieQi.getName() + '：' + jieQiSolar.getMonth() + '月' + jieQiSolar.getDay() + '日' + padding(jieQiSolar.getHour()) + ':' + padding(jieQiSolar.getMinute()) + '；';
    var nextJieQi = lunar.getNextJie();
    jieQiSolar = nextJieQi.getSolar();
    s += nextJieQi.getName() + '：' + jieQiSolar.getMonth() + '月' + jieQiSolar.getDay() + '日' + padding(jieQiSolar.getHour()) + ':' + padding(jieQiSolar.getMinute());
    s += '</td>';
    s += '</tr>';
    
    var riGan = '日干';
    var baziTitle = '八字';
    var daYunTitle = '大运';
    var liuNianTitle = '流年';
    var liuYueTitle = '流月';
    if(1==gender){
      baziTitle = '乾造';
      riGan = '元男';
    }else if(0==gender){
      baziTitle = '坤造';
      riGan = '元女';
    }else{
      daYunTitle = '';
      liuNianTitle = '';
      liuYueTitle = '';
    }
    s += '<tr>';
    s += '<td rowspan="4" valign="top">' + baziTitle + '：</td>';
    s += '<td>年柱</td>';
    s += '<td>月柱</td>';
    s += '<td>日柱</td>';
    s += '<td>时柱</td>';
    s += '<td></td>';
    s += '<td>'+daYunTitle+'</td>';
    s += '<td>'+liuNianTitle+'</td>';
    s += '<td>'+liuYueTitle+'</td>';
    s += '<td colspan="2"></td>';
    s += '</tr>';
    s += '<tr>';
    s += '<td class="small">' + bazi.getYearShiShenGan() + '</td>';
    s += '<td class="small">' + bazi.getMonthShiShenGan() + '</td>';
    s += '<td class="small red">' + riGan + '</td>';
    s += '<td class="small">' + bazi.getTimeShiShenGan() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunShiShen+'</td>';
      s += '<td class="small">'+currentYun.liuNianShiShen+'</td>';
      s += '<td class="small">'+currentYun.liuYueShiShen+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    s += '<tr>';
    s += '<td class="bazi">' + bazi.getYearGan()+'<br>'+bazi.getYearZhi() + '</td>';
    s += '<td class="bazi">' + bazi.getMonthGan()+'<br>'+bazi.getMonthZhi() + '</td>';
    s += '<td class="bazi">' + bazi.getDayGan()+'<br>'+bazi.getDayZhi() + '</td>';
    s += '<td class="bazi">' + bazi.getTimeGan()+'<br>'+bazi.getTimeZhi() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="bazi">'+(currentYun.daYunGanZhi?(currentYun.daYunGanZhi.substr(0,1)+'<br>'+currentYun.daYunGanZhi.substr(1)):'')+'</td>';
      s += '<td class="bazi">'+currentYun.liuNianGanZhi.substr(0,1)+'<br>'+currentYun.liuNianGanZhi.substr(1)+'</td>';
      s += '<td class="bazi">'+currentYun.liuYueGanZhi.substr(0,1)+'<br>'+currentYun.liuYueGanZhi.substr(1)+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    s += '<tr>';
    var hideGan = bazi.getYearHideGan();
    var shiShenZhi = bazi.getYearShiShenZhi();
    s += '<td valign="top" class="small">';
    for(var i=0,j=hideGan.length;i<j;i++){
      s += '<div' + (i==0?' class="red"':'') + '>'
      s += hideGan[i] + '-' + shiShenZhi[i];
      s += '</div>';
    }
    s += '</td>';
    hideGan = bazi.getMonthHideGan();
    shiShenZhi = bazi.getMonthShiShenZhi();
    s += '<td valign="top" class="small">';
    for(var i=0,j=hideGan.length;i<j;i++){
      s += '<div' + (i==0?' class="red"':'') + '>'
      s += hideGan[i] + '-' + shiShenZhi[i];
      s += '</div>';
    }
    s += '</td>';
    hideGan = bazi.getDayHideGan();
    shiShenZhi = bazi.getDayShiShenZhi();
    s += '<td valign="top" class="small">';
    for(var i=0,j=hideGan.length;i<j;i++){
      s += '<div' + (i==0?' class="red"':'') + '>'
      s += hideGan[i] + '-' + shiShenZhi[i];
      s += '</div>';
    }
    s += '</td>';
    hideGan = bazi.getTimeHideGan();
    shiShenZhi = bazi.getTimeShiShenZhi();
    s += '<td valign="top" class="small">';
    for(var i=0,j=hideGan.length;i<j;i++){
      s += '<div' + (i==0?' class="red"':'') + '>'
      s += hideGan[i] + '-' + shiShenZhi[i];
      s += '</div>';
    }
    s += '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small" valign="top">';
      for(var i=0,j=currentYun.daYunShiShenZhi.length;i<j;i++){
        s += '<div' + (i==0?' class="red"':'') + '>'
        s += currentYun.daYunShiShenZhi[i];
        s += '</div>';
      }
      s += '</td>';
      s += '<td class="small" valign="top">';
      for(var i=0,j=currentYun.liuNianShiShenZhi.length;i<j;i++){
        s += '<div' + (i==0?' class="red"':'') + '>'
        s += currentYun.liuNianShiShenZhi[i];
        s += '</div>';
      }
      s += '</td>';
      s += '<td class="small" valign="top">';
      for(var i=0,j=currentYun.liuYueShiShenZhi.length;i<j;i++){
        s += '<div' + (i==0?' class="red"':'') + '>'
        s += currentYun.liuYueShiShenZhi[i];
        s += '</div>';
      }
      s += '</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    
    var YinYang = {
      '甲':'阳',
      '丙':'阳',
      '戊':'阳',
      '庚':'阳',
      '壬':'阳',
      
      '子':'阳',
      '寅':'阳',
      '辰':'阳',
      '午':'阳',
      '申':'阳',
      '戌':'阳',
      
      '乙':'阴',
      '丁':'阴',
      '己':'阴',
      '辛':'阴',
      '癸':'阴',
      
      '丑':'阴',
      '卯':'阴',
      '巳':'阴',
      '未':'阴',
      '酉':'阴',
      '亥':'阴'
    };

    
    s += '<tr>';
    s += '<td>阴阳：</td>';
    s += '<td class="small">' + YinYang[bazi.getYearGan()] + YinYang[bazi.getYearZhi()] + '</td>';
    s += '<td class="small">' + YinYang[bazi.getMonthGan()] + YinYang[bazi.getMonthZhi()] + '</td>';
    s += '<td class="small">' + YinYang[bazi.getDayGan()] + YinYang[bazi.getDayZhi()] + '</td>';
    s += '<td class="small">' + YinYang[bazi.getTimeGan()] + YinYang[bazi.getTimeZhi()] + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">' + (currentYun.daYunGan ? YinYang[currentYun.daYunGan]:'') + (currentYun.daYunZhi ? YinYang[currentYun.daYunZhi]:'') + '</td>';
      s += '<td class="small">' + (currentYun.liuNianGan ? YinYang[currentYun.liuNianGan]:'') + (currentYun.liuNianZhi ? YinYang[currentYun.liuNianZhi]:'') + '</td>';
      s += '<td class="small">' + (currentYun.liuYueGan ? YinYang[currentYun.liuYueGan]:'') + (currentYun.liuYueZhi ? YinYang[currentYun.liuYueZhi]:'') + '</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';

    s += '<tr>';
    s += '<td>五行：</td>';
    s += '<td class="small">' + bazi.getYearWuXing() + '</td>';
    s += '<td class="small">' + bazi.getMonthWuXing() + '</td>';
    s += '<td class="small">' + bazi.getDayWuXing() + '</td>';
    s += '<td class="small">' + bazi.getTimeWuXing() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunWuXing+'</td>';
      s += '<td class="small">'+currentYun.liuNianWuXing+'</td>';
      s += '<td class="small">'+currentYun.liuYueWuXing+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    
    s += '<tr>';
    s += '<td>旺衰：</td>';
    var wxguanxi = {
	'寅卯':'木旺 火相 水休 金囚 土死',
	'巳午':'火旺 土相 木休 水囚 金死',
	'申酉':'金旺 水相 土休 火囚 木死',
	'亥子':'水旺 木相 金休 土囚 火死',
	'辰戌丑未':'土旺 金相 火休 木囚 水死'
    };
    var monthZhi = bazi.getMonthZhi();
    var wx = '';
    for(var i in wxguanxi){
        if(i.indexOf(monthZhi )>-1){
            wx = wxguanxi[i];
            break;
        }
    }
    s += '<td colspan="10" class="left small">' + bazi.getDayGan() + LunarUtil.WU_XING_GAN[bazi.getDayGan()] + '生于' + bazi.getMonthZhi() + '月 ' + wx +'</td>';
    s += '</tr>';

    s += '<tr>';
    s += '<td>地势：</td>';
    s += '<td class="small">' + bazi.getYearDiShi() + '</td>';
    s += '<td class="small">' + bazi.getMonthDiShi() + '</td>';
    s += '<td class="small">' + bazi.getDayDiShi() + '</td>';
    s += '<td class="small">' + bazi.getTimeDiShi() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunDiShi+'</td>';
      s += '<td class="small">'+currentYun.liuNianDiShi+'</td>';
      s += '<td class="small">'+currentYun.liuYueDiShi+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    
    s += '<tr>';
    s += '<td>长生：</td>';
    s += '<td class="small">' + getChangSheng(bazi.getYearGan(), lunar.getYearGanIndexExact(), lunar.getYearZhiIndexExact()) + '</td>';
    s += '<td class="small">' + getChangSheng(bazi.getMonthGan(), lunar.getMonthGanIndexExact(), lunar.getMonthZhiIndexExact()) + '</td>';
    s += '<td class="small">' + getChangSheng(bazi.getDayGan(), 2 == bazi.getSect() ? lunar.getDayGanIndexExact2() : lunar.getDayGanIndexExact(), 2 == bazi.getSect() ? lunar.getDayZhiIndexExact2() : lunar.getDayZhiIndexExact()) + '</td>';
    s += '<td class="small">' + getChangSheng(bazi.getTimeGan(), lunar.getTimeGanIndex(), lunar.getTimeZhiIndex()) + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunChangSheng+'</td>';
      s += '<td class="small">'+currentYun.liuNianChangSheng+'</td>';
      s += '<td class="small">'+currentYun.liuYueChangSheng+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';

    s += '<tr>';
    s += '<td>空亡：</td>';
    s += '<td class="small">' + bazi.getYearXunKong() + '</td>';
    s += '<td class="small">' + bazi.getMonthXunKong() + '</td>';
    s += '<td class= "red small">' + bazi.getDayXunKong() + '</td>';
    s += '<td class="small">' + bazi.getTimeXunKong() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunXunKong+'</td>';
      s += '<td class="small">'+currentYun.liuNianXunKong+'</td>';
      s += '<td class="small">'+currentYun.liuYueXunKong+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    
    s += '<tr>';
    s += '<td>纳音：</td>';
    s += '<td class="small">' + bazi.getYearNaYin() + '</td>';
    s += '<td class="small">' + bazi.getMonthNaYin() + '</td>';
    s += '<td class="small">' + bazi.getDayNaYin() + '</td>';
    s += '<td class="small">' + bazi.getTimeNaYin() + '</td>';
    if(currentYun){
      s += '<td></td>';
      s += '<td class="small">'+currentYun.daYunNaYin+'</td>';
      s += '<td class="small">'+currentYun.liuNianNaYin+'</td>';
      s += '<td class="small">'+currentYun.liuYueNaYin+'</td>';
      s += '<td colspan="2"></td>';
    }else{
      s += '<td colspan="6"></td>';
    }
    s += '</tr>';
    
    s += '<tr>';
    
    // 年柱神煞
    var shenShaYear = [];
    // 月柱神煞
    var shenShaMonth = [];
    // 日柱神煞
    var shenShaDay = [];
    // 时柱神煞
    var shenShaTime = [];
    // 大运神煞
    var shenShadaYun = [];
    // 流年神煞
    var shenShaliuNian = [];
    // 流月神煞
    var shenShaliuYue = [];    
    
    //四柱天干顺序同时出现
    var shenShaGanGan = {     
      '天上三奇' :['甲戊庚', '庚戊甲'],
      '地上三奇' :['乙丙丁', '丁丙乙'],	  
      '人中三奇' :['壬癸辛', '辛癸壬']	 
    };
   
    // 年日天干查地支
    var shenShaYearDayGanZhi = {
      '天乙' : ['甲丑', '甲未', '乙子', '乙申', '丙亥', '丙酉', '丁亥', '丁酉', '戊丑', '戊未', '己子', '己申', '庚午', '庚寅', '辛午', '辛寅', '壬卯', '壬巳', '癸卯', '癸巳'],
      '太极' : ['甲子', '甲午', '乙子', '乙午', '丙卯', '丙酉', '丁卯', '丁酉', '戊辰', '戊戌', '戊丑', '戊未', '己辰', '己戌', '己丑', '己未', '庚亥', '庚寅', '辛亥', '辛寅', '壬申', '壬巳', '癸申', '癸巳'],
      '文昌' : ['甲巳', '乙午', '丙申', '丁酉', '戊申', '己酉', '庚亥', '辛子', '壬寅', '癸卯'],
      '国印' : ['甲戌', '乙亥', '丙丑', '丁寅', '戊丑', '己寅', '庚辰', '辛巳', '壬未', '癸申'],
      '福星' : ['甲寅', '甲子', '乙卯', '乙丑', '丙寅', '丙子', '丁亥', '戊申', '己未', '庚午', '辛辰', '壬辰', '癸卯', '癸丑'],
      '禄神' : ['甲寅', '乙卯', '丙巳', '丁午', '戊巳', '己午', '庚申', '辛酉', '壬亥', '癸子'], 
      '金舆' : ['甲辰', '乙巳', '丙未', '丁申', '戊未', '己申', '庚戌', '辛亥', '壬丑', '癸寅']
    };
    
    // 年日天干查各柱干支
    var shenShaYearGanDayGanGanZhi = {    
       '学堂' : ['甲己亥', '乙壬午', '丙丙寅', '丁丁酉', '戊戊寅', '己己酉', '庚辛巳', '辛甲子', '壬甲申', '癸乙卯'], 
       '词馆' : ['甲庚寅', '乙辛卯', '丙乙巳', '丁戊午', '戊丁巳', '己庚午', '庚壬申', '辛癸酉', '壬癸亥', '癸壬戌']
    };
    
    // 年日地支查地支
    var shenShaYearDayZhiZhi = {
      '六厄' : ['子卯', '丑子', '寅酉', '卯午', '辰卯', '巳子', '午酉', '未午', '申卯', '酉子', '戌酉', '亥午'], 
      '孤辰' : ['子寅', '丑寅', '寅巳', '卯巳', '辰巳', '巳申', '午申', '未申', '申亥', '酉亥', '戌亥', '亥寅'], 
      '寡宿' : ['子戌', '丑戌', '寅丑', '卯丑', '辰丑', '巳辰', '午辰', '未辰', '申未', '酉未', '戌未', '亥戌'], 
      '桃花' : ['子酉', '丑午', '寅卯', '卯子', '辰酉', '巳午', '午卯', '未子', '申酉', '酉午', '戌卯', '亥子'],       
      '亡神' : ['子亥', '丑申', '寅巳', '卯寅', '辰亥', '巳申', '午巳', '未寅', '申亥', '酉申', '戌巳', '亥寅'],      
      '劫煞' : ['子巳', '丑寅', '寅亥', '卯申', '辰巳', '巳寅', '午亥', '未申', '申巳', '酉寅', '戌亥', '亥申'],       
      '灾煞' : ['子午', '丑卯', '寅子', '卯酉', '辰午', '巳卯', '午子', '未酉', '申午', '酉卯', '戌子', '亥酉'],       
      '驿马' : ['子寅', '丑亥', '寅申', '卯巳', '辰寅', '巳亥', '午申', '未巳', '申寅', '酉亥', '戌申', '亥巳'], 
      '华盖' : ['子辰', '丑丑', '寅戌', '卯未', '辰辰', '巳丑', '午戌', '未未', '申辰', '酉丑', '戌戌', '亥未'],
      '将星' : ['子子', '丑酉', '寅午', '卯卯', '辰子', '巳酉', '午午', '未卯', '申子', '酉酉', '戌午', '亥卯'],
      '天罗' : ['戌亥', '亥戌'],
      '地网' : ['辰巳', '巳辰']      
    };

    // 年支查大运流年地支
    var shenShaYearZhidaYunliuNianZhi = {
      '丧门' : ['子寅', '丑卯', '寅辰', '卯巳', '辰午', '巳未', '午申', '未酉', '申戌', '酉亥', '戌子', '亥丑'],
      '吊客' : ['子戌', '丑亥', '寅子', '卯丑', '辰寅', '巳卯', '午辰', '未巳', '申午', '酉未', '戌申', '亥酉']
    };

    // 年日地支查大运流年地支
    var shenShaYearZhiDayZhidaYunliuNianZhi = {
      '披麻' : ['子酉', '丑戌', '寅亥', '卯子', '辰丑', '巳寅', '午卯', '未辰', '申巳', '酉午', '戌未', '亥申']
    };
    
    //年支查地支
    var shenShaYearZhiDiZhi = {     
      '红鸾' : ['子卯', '丑寅', '寅丑', '卯子', '辰亥', '巳戌', '午酉', '未申', '申未', '酉午', '戌巳', '亥辰'],  
      '天喜' : ['子酉', '丑申', '寅未', '卯午', '辰巳', '巳辰', '午卯', '未寅', '申丑', '酉子', '戌亥', '亥戌']
    };
    
    // 月支查天干或地支
    var shenShaMonthZhiGanZhi = {    
      '天德' : ['午亥', '子巳'], 	  
      '德秀(德)' : ['卯乙', '辰癸','辰戊', '午丁', '未乙', '酉辛', '戌丁', '子癸', '子戊', '丑辛'],
      '德秀(秀)' : ['寅戊', '寅癸','卯丁', '卯壬', '辰丙', '辰辛', '辰甲', '午戊', '午癸', '未丁', '未壬', '申丙', '申辛', '申甲', '戌戊', '戌癸', '亥丁', '亥壬', '子丙', '子辛', '子甲'],
      '德秀' : ['辰己', '申己', '子己'],	  
      '天德 德秀(德)' : ['寅丁', '辰壬','巳辛', '申癸','亥乙', '戌丙'],
      '月德 德秀(德)' : ['寅丙', '卯甲', '午丙', '申壬','亥甲', '子壬'],
      '月德 德秀' : ['巳庚', '酉庚'], 	  
      '天德合' : ['寅壬', '卯巳', '巳丙', '午寅', '酉亥', '亥庚', '子申'], 
      '月德合' : ['寅辛', '卯己', '', '午辛', '申丁', '亥己', '子丁'],
      '天德合 月德合' : ['辰丁', '未己', '戌辛'],
      '天德合 德秀(德)' : ['申戊'],
      '月德合 德秀(德)' : ['巳乙'],
      '天德合 德秀(秀)' : ['丑乙'],
      '月德合 德秀(秀)' : ['酉乙'],	  
      '天德 月德 德秀(德)' : ['未甲'],
      '天德 月德 德秀' : ['丑庚'],	  
      '阴注阳受' : ['寅子', '卯亥', '辰戌', '巳酉', '午戌', '未亥', '申子', '酉丑', '戌寅', '亥卯', '子寅', '丑丑'],
      '天医' : ['寅丑', '卯寅', '辰卯', '巳辰', '午巳', '未午', '申未', '酉申', '戌酉', '亥戌', '子亥', '丑子']
    };
     
     //月支查日干支
    var shenShaMonthZhiDayGanZhi = {    
      '四废' : ['寅庚申', '卯庚申', '辰庚申', '寅辛酉', '卯辛酉', '辰辛酉', '巳壬子', '午壬子', '未壬子', '巳癸亥', '午癸亥', '未癸亥', '申甲寅', '酉甲寅', '戌甲寅', '申乙卯', '酉乙卯', '戌乙卯', '亥丙午', '子丙午', '丑丙午', '亥丁巳', '子丁巳', '丑丁巳'],
      '天赦' : ['寅戊寅', '卯戊寅', '辰戊寅', '巳甲午', '午甲午', '未甲午', '申戊申', '酉戊申', '戌戊申', '亥甲子', '子甲子', '丑甲子']
    };
       
    //查日时干支    
    var shenShaDayTimeGanZhi = {    
       '孤鸾' : ['乙巳', '丁巳', '辛亥', '戊申', '甲寅', '戊午', '丙午', '壬子'],
       '金神' : ['乙丑', '己巳', '癸酉']       
    };
    
     //只查日干支
    var shenShaDayDayGanZhi = {    
       '阴差阳错' : ['丙子', '丁丑', '戊寅', '辛卯', '壬辰', '癸巳', '丙午', '丁未', '戊申', '辛酉', '壬戌', '癸亥'], 
       '十恶大败' : ['甲辰', '乙巳', '丙申', '丁亥', '戊戌', '己丑', '庚辰', '辛巳', '壬申', '癸亥'],
       '魁罡' : ['壬辰', '庚辰', '庚戌', '戊戌']
    };
    
    //日干查地支    
    var shenShaDayGanDiZhi = { 
      '羊刃' : ['甲卯', '乙寅', '丙午', '丁巳', '戊午', '己巳', '庚酉', '辛申', '壬子', '癸亥'],
      '天厨' : ['甲巳', '乙午', '丙巳', '丁午', '戊申', '己酉', '庚亥', '辛子', '壬寅', '癸卯'],
      '红艳' : ['甲午', '乙申', '丙寅', '丁未', '戊辰', '己辰', '庚戌', '辛酉', '壬子', '癸申'],
      '流霞' : ['甲酉', '乙戌', '丙未', '丁申', '戊巳', '己午', '庚辰', '辛卯', '壬亥', '癸寅']
    };     

    //童子(月支查日支时支)
    var shenShaMonthZhiDayZhiTimeZhi = {     
      '童子' : ['寅寅', '卯寅', '辰寅', '申寅', '酉寅', '戌寅', '寅子', '卯子', '辰子', '申子', '酉子', '戌子', '巳卯', '午卯', '未卯', '亥卯', '子卯', '丑卯', '巳未', '午未', '未未', '亥未', '子未', '丑未', '巳辰', '午辰', '未辰', '亥辰', '子辰', '丑辰']
    };     
    //童子(年柱纳音查日支和时支)
    var shenShaYearNaYinDayZhiTimeZhi = {     
      '童子' : ['海中金午', '剑锋金午', '白蜡金午', '沙中金午', '金箔金午', '钗钏金午', '大林木午', '杨柳木午', '松柏木午', '平地木午', '桑柘木午', '石榴木午', '海中金卯', '剑锋金卯', '白蜡金卯', '沙中金卯', '金箔金卯', '钗钏金卯', '大林木卯', '杨柳木卯', '松柏木卯', '平地木卯', '桑柘木卯', '石榴木卯', '涧下水戌', '泉中水戌', '长流水戌', '天河水戌', '大溪水戌', '大海水戌', '涧下水酉', '泉中水酉', '长流水酉', '天河水酉', '大溪水酉', '大海水酉', '霹雳火戌', '山下火戌', '覆灯火戌', '炉中火戌', '山头火戌', '天上火戌', '霹雳火酉', '山下火酉', '覆灯火酉', '炉中火酉', '山头火酉', '天上火酉', '壁上土辰', '大驿土辰', '沙中土辰', '路旁土辰', '城头土辰', '屋上土辰', '壁上土巳', '大驿土巳', '沙中土巳', '路旁土巳', '城头土巳', '屋上土巳']
    };
    
    //日柱查地支    
    var shenShaDayGanZhiZhi = {     
      '空亡' : ['bazi.getDayXunKong()']
    }; 
    
    // 年支查地支，男女分别看（阳男阴女）
    var shenShaYearZhiZhiYangNanYinNv = {     
      '勾煞' : ['子卯', '丑辰', '寅巳', '卯午', '辰未', '巳申', '午酉', '未戌', '申亥', '酉子', '戌丑', '亥寅'],
      '绞煞' : ['子酉', '丑戌', '寅亥', '卯子', '辰丑', '巳寅', '午卯', '未辰', '申巳', '酉午', '戌未', '亥申'],
      '元辰' : ['子未', '丑申', '寅酉', '卯戌', '辰亥', '巳子', '午丑', '未寅', '申卯', '酉辰', '戌巳', '亥午']
    };
    
    // 年支查地支，男女分别看（阴男阳女）    
    var shenShaYearZhiZhiYinNanYangNv = {      
      '勾煞' : ['子酉', '丑戌', '寅亥', '卯子', '辰丑', '巳寅', '午卯', '未辰', '申巳', '酉午', '戌未', '亥申'],  
      '绞煞' : ['子卯', '丑辰', '寅巳', '卯午', '辰未', '巳申', '午酉', '未戌', '申亥', '酉子', '戌丑', '亥寅'],  
      '元辰' : ['子巳', '丑午', '寅未', '卯申', '辰酉', '巳戌', '午亥', '未子', '申丑', '酉寅', '戌卯', '亥辰']    
    };
    
    // 阳
    var yang = (0 == lunar.getYearGanIndexExact() % 2);
    // 男
    var man = (1 == gender);
    // 阳男阴女
    var yangManOrYinWoman = (yang && man) || (!yang && !man);
    // 根据阳男阴女或阴男阳女选择不同的关系
    var shenShaYearZhiZhiNN = yangManOrYinWoman ? shenShaYearZhiZhiYangNanYinNv : shenShaYearZhiZhiYinNanYangNv;
  
    // 年柱神煞开始
    // 每柱神煞开始才加这一行
    var shenShaTemp = {};
 
    for(var i in shenShaGanGan){
      var gzs = shenShaGanGan[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getMonthGan()+bazi.getDayGan() || gz == bazi.getMonthGan()+bazi.getDayGan()+bazi.getTimeGan()){
          shenShaTemp[i] = true;
        }
      }
    }
	
    for(var i in shenShaYearDayGanZhi){
      var gzs = shenShaYearDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getYearZhi() || gz == bazi.getDayGan()+bazi.getYearZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearDayZhiZhi){
      var gzs = shenShaYearDayZhiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDayZhi()+bazi.getYearZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiGanZhi){
      var gzs = shenShaMonthZhiGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getYearGan() || gz == bazi.getMonthZhi()+bazi.getYearZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayGanDiZhi){
      var gzs = shenShaDayGanDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDayGan()+bazi.getYearZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearGanDayGanGanZhi){
      var gzs = shenShaYearGanDayGanGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDayGan()+bazi.getYear()){
          shenShaTemp[i] = true;
        }
      }
    }
    // 神煞结束才调用这段
    for(var i in shenShaTemp){
      shenShaYear.push(i);
    }
    // 年柱神煞结束
    
    // 月柱神煞开始
    shenShaTemp = {};
    for(var i in shenShaYearDayGanZhi){
      var gzs = shenShaYearDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getMonthZhi() || gz == bazi.getDayGan()+bazi.getMonthZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearDayZhiZhi){
      var gzs = shenShaYearDayZhiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getMonthZhi() || gz == bazi.getDayZhi()+bazi.getMonthZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiGanZhi){
      var gzs = shenShaMonthZhiGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getMonthGan()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayGanDiZhi){
      var gzs = shenShaDayGanDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDayGan()+bazi.getMonthZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiDiZhi){
      var gzs = shenShaYearZhiDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getMonthZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearGanDayGanGanZhi){
      var gzs = shenShaYearGanDayGanGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getMonth() || gz == bazi.getDayGan()+bazi.getMonth()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiZhiNN){
      var gzs = shenShaYearZhiZhiNN[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getMonthZhi()){
          shenShaTemp[i] = true;
        }
      }
    }
        
    for(var i in shenShaTemp){
      shenShaMonth.push(i);
    }
    // 月柱神煞结束
	
    // 日柱神煞开始      
    shenShaTemp = {};
    for(var i in shenShaYearDayGanZhi){
      var gzs = shenShaYearDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getDayZhi() || gz == bazi.getDayGan()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearDayZhiZhi){
      var gzs = shenShaYearDayZhiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }
    for(var i in shenShaTemp){
      shenShaDay.push(i);
    }
    
    shenShaTemp = {};
    for(var i in shenShaMonthZhiGanZhi){
      var gzs = shenShaMonthZhiGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getDayGan() || gz == bazi.getMonthZhi()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayTimeGanZhi){
      var gzs = shenShaDayTimeGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDay()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayDayGanZhi){
      var gzs = shenShaDayDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDay()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayGanDiZhi){
      var gzs = shenShaDayGanDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDay()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiDiZhi){
      var gzs = shenShaYearZhiDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiDayZhiTimeZhi){
      var gzs = shenShaMonthZhiDayZhiTimeZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearNaYinDayZhiTimeZhi){
      var gzs = shenShaYearNaYinDayZhiTimeZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearNaYin()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearGanDayGanGanZhi){
      var gzs = shenShaYearGanDayGanGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getDay()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiDayGanZhi){
      var gzs = shenShaMonthZhiDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getDay()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiZhiNN){
      var gzs = shenShaYearZhiZhiNN[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getDayZhi()){
          shenShaTemp[i] = true;
        }
      }
    }
        
    for(var i in shenShaTemp){
      shenShaDay.push(i);
    }
    // 日柱神煞结束
	
    // 时柱神煞开始 
    shenShaTemp = {};
    for(var i in shenShaYearDayGanZhi){
      var gzs = shenShaYearDayGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getTimeZhi() || gz == bazi.getDayGan()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearDayZhiZhi){
      var gzs = shenShaYearDayZhiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getTimeZhi() || gz == bazi.getDayZhi()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiGanZhi){
      var gzs = shenShaMonthZhiGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getTimeGan() || gz == bazi.getMonthZhi()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayTimeGanZhi){
      var gzs = shenShaDayTimeGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getTime()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaDayGanDiZhi){
      var gzs = shenShaDayGanDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getDayGan()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiDiZhi){
      var gzs = shenShaYearZhiDiZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaMonthZhiDayZhiTimeZhi){
      var gzs = shenShaMonthZhiDayZhiTimeZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getMonthZhi()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearNaYinDayZhiTimeZhi){
      var gzs = shenShaYearNaYinDayZhiTimeZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearNaYin()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearGanDayGanGanZhi){
      var gzs = shenShaYearGanDayGanGanZhi[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearGan()+bazi.getTime() || gz == bazi.getDayGan()+bazi.getTime()){
          shenShaTemp[i] = true;
        }
      }
    }

    for(var i in shenShaYearZhiZhiNN){
      var gzs = shenShaYearZhiZhiNN[i];
      for(var j=0,k=gzs.length;j<k;j++){
        var gz = gzs[j];
        if(gz == bazi.getYearZhi()+bazi.getTimeZhi()){
          shenShaTemp[i] = true;
        }
      }
    }
    
    for(var i in shenShaTemp){
      shenShaTime.push(i);
    }
    // 时柱神煞结束
 
    // 大运神煞开始
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayGanZhi){
          var gzs = shenShaYearDayGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.daYunGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayZhiZhi){
          var gzs = shenShaYearDayZhiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.daYunGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaMonthZhiGanZhi){
          var gzs = shenShaMonthZhiGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getMonthZhi()+currentYun.daYunGanZhi.substr(0,1) || gz == bazi.getMonthZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaDayGanDiZhi){
          var gzs = shenShaDayGanDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getDayGan()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDiZhi){
          var gzs = shenShaYearZhiDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearGanDayGanGanZhi){
          var gzs = shenShaYearGanDayGanGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.daYunGanZhi.substr(0,1)+currentYun.daYunGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.daYunGanZhi.substr(0,1)+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }

    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhidaYunliuNianZhi){
          var gzs = shenShaYearZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
      
    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDayZhidaYunliuNianZhi){
          var gzs = shenShaYearZhiDayZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.daYunGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }    

    if(currentYun){
      if(currentYun.daYunGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiZhiNN){
          var gzs = shenShaYearZhiZhiNN[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.daYunGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShadaYun.push(i);
        }
      }
    }
    // 大运神煞结束
 
    // 流年神煞开始      
      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayGanZhi){
          var gzs = shenShaYearDayGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.liuNianGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }

      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayZhiZhi){
          var gzs = shenShaYearDayZhiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuNianGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }
      
      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaMonthZhiGanZhi){
          var gzs = shenShaMonthZhiGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getMonthZhi()+currentYun.liuNianGanZhi.substr(0,1) || gz == bazi.getMonthZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }
      
      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaDayGanDiZhi){
          var gzs = shenShaDayGanDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getDayGan()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }
      
      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDiZhi){
          var gzs = shenShaYearZhiDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }

      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearGanDayGanGanZhi){
          var gzs = shenShaYearGanDayGanGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.liuNianGanZhi.substr(0,1)+currentYun.liuNianGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.liuNianGanZhi.substr(0,1)+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }
      
      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhidaYunliuNianZhi){
          var gzs = shenShaYearZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }

      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDayZhidaYunliuNianZhi){
          var gzs = shenShaYearZhiDayZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuNianGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }

      if(currentYun.liuNianGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiZhiNN){
          var gzs = shenShaYearZhiZhiNN[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuNianGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuNian.push(i);
        }
      }
    // 流年神煞结束
 
    // 流月神煞开始	  
      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayGanZhi){
          var gzs = shenShaYearDayGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.liuYueGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearDayZhiZhi){
          var gzs = shenShaYearDayZhiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuYueGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaMonthZhiGanZhi){
          var gzs = shenShaMonthZhiGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getMonthZhi()+currentYun.liuYueGanZhi.substr(0,1) || gz == bazi.getMonthZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaDayGanDiZhi){
          var gzs = shenShaDayGanDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getDayGan()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDiZhi){
          var gzs = shenShaYearZhiDiZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearGanDayGanGanZhi){
          var gzs = shenShaYearGanDayGanGanZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearGan()+currentYun.liuYueGanZhi.substr(0,1)+currentYun.liuYueGanZhi.substr(1) || gz == bazi.getDayGan()+currentYun.liuYueGanZhi.substr(0,1)+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhidaYunliuNianZhi){
          var gzs = shenShaYearZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiDayZhidaYunliuNianZhi){
          var gzs = shenShaYearZhiDayZhidaYunliuNianZhi[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuYueGanZhi.substr(1) || gz == bazi.getDayZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }

      if(currentYun.liuYueGanZhi){
        shenShaTemp = {};
        for(var i in shenShaYearZhiZhiNN){
          var gzs = shenShaYearZhiZhiNN[i];
          for(var j=0,k=gzs.length;j<k;j++){
            var gz = gzs[j];
            if(gz == bazi.getYearZhi()+currentYun.liuYueGanZhi.substr(1)){
              shenShaTemp[i] = true;
            }
          }
        }
        for(var i in shenShaTemp){
          shenShaliuYue.push(i);
        }
      }
    // 流月神煞结束
    
    //日柱空亡
    var rzkw=bazi.getDayXunKong();
        //年支
		var yearZhi=bazi.getYearZhi();
		//月支
		var monthZhi=bazi.getMonthZhi();
		//日支
		var dayZhi=bazi.getDayZhi();
		//时支
		var timeZhi=bazi.getTimeZhi();
        //大运支
		var daYunZhi;
		if(currentYun.daYunGanZhi){
			daYunZhi=currentYun.daYunGanZhi.substr(1);
		}
		//流年支
		var liuNianZhi;
		if(currentYun.liuNianGanZhi){
			liuNianZhi=currentYun.liuNianGanZhi.substr(1);
		}
		//流月支
		var liuYueZhi;
		if(currentYun.liuYueGanZhi){
			liuYueZhi=currentYun.liuYueGanZhi.substr(1);
		}

		
		if(rzkw.indexOf(yearZhi) != -1){
				shenShaYear.push("空亡");
		}
		if(rzkw.indexOf(monthZhi) != -1){
				shenShaMonth.push("空亡");
		}
		if(rzkw.indexOf(dayZhi) != -1){
				shenShaDay.push("空亡");
		}
		if(rzkw.indexOf(timeZhi) != -1){
				shenShaTime.push("空亡");
		}
 		if(rzkw.indexOf(daYunZhi) != -1){
				shenShadaYun.push("空亡");
		}
		if(rzkw.indexOf(liuNianZhi) != -1){
				shenShaliuNian.push("空亡");
		}
		if(rzkw.indexOf(liuYueZhi) != -1){
				shenShaliuYue.push("空亡");
		}    
 
    s += '<td>年柱：</td>';
    s += '<td colspan="10" class="left small">'+ shenShaYear.join(' ') +'</td>';
    s += '</tr>'; 
    
    s += '<tr>';
    s += '<td>月柱：</td>';
    s += '<td colspan="10" class="left small">'+ shenShaMonth.join(' ') +'</td>';
    s += '</tr>';

    s += '<tr>';
    s += '<td>日柱：</td>';
    s += '<td colspan="10" class="left small">'+ shenShaDay.join(' ') +'</td>';	
    s += '</tr>';    

    s += '<tr>';
    s += '<td>时柱：</td>';
    s += '<td colspan="10" class="left small">'+ shenShaTime.join(' ') +'</td>';		
    s += '</tr>';  

    s += '<tr>';
    s += '<td>大运：</td>';
    s += '<td colspan="10" class="left small">'+ (shenShadaYun.length<1 ? '当前十年不显示大运' : shenShadaYun.join(' ')) +'</td>';	
    s += '</tr>';

    s += '<tr>';
    s += '<td>流年：</td>';
    s += '<td colspan="10" class="left small">'+ (shenShaliuNian.length<1 ? '无吉神凶煞' : shenShaliuNian.join(' ')) +'</td>';	
    s += '</tr>';
    
    s += '<tr>';
    s += '<td>流月：</td>';
    s += '<td colspan="10" class="left small">'+ (shenShaliuYue.length<1 ? '无吉神凶煞' : shenShaliuYue.join(' ')) +'</td>';	
    s += '</tr>';    

    s += '<tr>';
    s += '<td>天干：</td>';
    var tgguanxi = {
	'甲己':'甲己合土',
	'乙庚':'乙庚合金',
	'丙辛':'丙辛合水',
	'丁壬':'丁壬合木',
	'戊癸':'戊癸合火',
	'甲庚':'甲庚相冲',
	'乙辛':'乙辛相冲',
	'丙壬':'丙壬相冲',
	'丁癸':'丁癸相冲' 
    };
    var gans = [];
    gans.push(bazi.getYearGan());
    gans.push(bazi.getMonthGan());
    gans.push(bazi.getDayGan());
    gans.push(bazi.getTimeGan());
    if(currentYun){
      if(currentYun.daYunGanZhi){
        gans.push(currentYun.daYunGanZhi.substr(0,1));
      }
      if(currentYun.liuNianGanZhi){
        gans.push(currentYun.liuNianGanZhi.substr(0,1));
      }
      if(currentYun.liuYueGanZhi){
        gans.push(currentYun.liuYueGanZhi.substr(0,1));
      }
    }
        
    var matched=[];
    var gxs = {};    
        var size=gans.length;
        for(var i=0;i<size;i++){
          for(var j=0;j<size;j++){
            if(i===j){
              continue;
    }
    var v=tgguanxi[gans[i]+gans[j]];
    if(v){
      gxs[v] = true;
        }
      }
    }
    for(var i in gxs){
     matched.push(i);
    }
    s += '<td colspan="10" class="left small">'+(matched.length<1 ? '天干无冲合' : matched.join(' '))+'</td>';;
    s += '</tr>'; 
    
    s += '<tr>';
    s += '<td>地支：</td>';
    var dzguanxi = {
	'亥子丑':'亥子丑三会水',
	'寅卯辰':'寅卯辰三会木',
	'巳午未':'巳午未三会火',
	'申酉戌':'申酉戌三会金',
	'申子辰':'申子辰三合水',
	'寅午戌':'寅午戌三合火',
	'亥卯未':'亥卯未三合木',
	'巳酉丑':'巳酉丑三合金', 
	'申子':'申子半合水',
	'子辰':'子辰半合水',	
	'午戌':'午戌半合火',	
	'亥卯':'亥卯半合木',
	'卯未':'卯未半合木',	
	'酉丑':'酉丑半合金',
	'寅午':'寅午半合火(暗合土)',
	'巳酉':'巳酉半合金(暗合水)',	
	'子巳':'子巳暗合火',
	'卯申':'卯申暗合金',
	'亥午':'亥午暗合木', 	
	'巳申':'巳申六合水',
	'辰酉':'辰酉六合金',
	'卯戌':'卯戌六合火',
	'寅亥':'寅亥六合木(相破)',
	'子丑':'子丑六合土',
	'午未':'午未六合火或土',
	'子卯':'子卯无礼相刑',
	'丑未戌':'丑未戌恃势刑',
	'寅巳申':'寅巳申无恩刑',	
	'辰辰':'辰辰自刑',
	'午午':'午午自刑',
	'酉酉':'酉酉自刑',
	'亥亥':'亥亥自刑',
	'子午':'子午相冲',
	'卯酉':'卯酉相冲',
	'寅申':'寅申相冲',
	'巳亥':'巳亥相冲',
	'辰戌':'辰戌相冲',
	'丑未':'丑未相冲',
	'子未':'子未相害',
	'丑午':'丑午相害',
	'寅巳':'寅巳相害',
	'卯辰':'卯辰相害',
	'申亥':'申亥相害',
	'酉戌':'酉戌相害',
	'子酉':'子酉相破',
	'卯午':'卯午相破',
	'辰丑':'辰丑相破',
	'巳申':'巳申相破',
	'未戌':'未戌相破'
    };
    var zhis = {};
    zhis[bazi.getYearZhi()] = zhis[bazi.getYearZhi()] ? zhis[bazi.getYearZhi()]+1 : 1;
    zhis[bazi.getMonthZhi()] = zhis[bazi.getMonthZhi()] ? zhis[bazi.getMonthZhi()]+1 : 1;
    zhis[bazi.getDayZhi()] = zhis[bazi.getDayZhi()] ? zhis[bazi.getDayZhi()]+1 : 1;
    zhis[bazi.getTimeZhi()] = zhis[bazi.getTimeZhi()] ? zhis[bazi.getTimeZhi()]+1 : 1;
    if(currentYun){
      if(currentYun.daYunZhi){
        zhis[currentYun.daYunZhi] = zhis[currentYun.daYunZhi] ? zhis[currentYun.daYunZhi]+1 : 1;
      }
      if(currentYun.liuNianZhi){
        zhis[currentYun.liuNianZhi] = zhis[currentYun.liuNianZhi] ? zhis[currentYun.liuNianZhi]+1 : 1;
      }
      if(currentYun.liuYueZhi){
        zhis[currentYun.liuYueZhi] = zhis[currentYun.liuYueZhi] ? zhis[currentYun.liuYueZhi]+1 : 1;
      }
    }

    var matched=[];
    var gxs = {};
    for(var i in zhis){
      for(var j in zhis){
        for(var k in zhis){
          if(i==j||j==k||i==k){
            continue;
          }
          var v=dzguanxi[i+j];
          if(v){
            gxs[v] = true;
          }
          v=dzguanxi[i+j+k];
          if(v){
            gxs[v] = true;
          }
        }
      }
    }
    for(var i in zhis){
      var n = zhis[i];
      var vs = [];
      for(var j=0;j<n;j++){
        vs.push(i);
      }
      var v=dzguanxi[vs.join('')];
      if(v){
        gxs[v] = true;
      }
    }

    var matchIndex = 0;
    for(var i in gxs){
         matched.push(i);
         matchIndex ++;
         if(matchIndex%5==0){
             matched.push('<br>');
         }
    }
    s += '<td colspan="10" class="left small">'+(matched.join(' '))+'</td>';

    
    s += '<tr>';
    s += '<td>太岁：</td>';
    var tsguanxi = {
	'子子':'值太岁',
	'丑丑':'值太岁',
	'寅寅':'值太岁',
	'卯卯':'值太岁',
	'巳巳':'值太岁',
	'未未':'值太岁',
	'申申':'值太岁',
	'戌戌':'值太岁',	
	'子卯':'刑太岁',
	'丑戌':'刑太岁(丑戌未三刑)',	
	'辰辰':'刑太岁(值)',
	'午午':'刑太岁(值)',
	'酉酉':'刑太岁(值)',
	'亥亥':'刑太岁(值)',
	'子午':'冲太岁',
	'卯酉':'冲太岁',
	'寅申':'冲太岁(寅巳申三刑)',
	'巳亥':'冲太岁',
	'辰戌':'冲太岁',
	'丑未':'冲太岁(丑戌未三刑)',
	'子未':'害太岁',
	'丑午':'害太岁',
	'寅巳':'害太岁(寅巳申三刑)',
	'卯辰':'害太岁',
	'申亥':'害太岁',
	'酉戌':'害太岁',
	'子酉':'破太岁',
	'卯午':'破太岁',
	'辰丑':'破太岁',
	'寅亥':'破太岁',	
	'巳申':'破太岁(寅巳申三刑)',
	'未戌':'破太岁(丑戌未三刑)'	
    };
    var zhis = [];
    zhis.push(bazi.getYearZhi());
    if(currentYun){
      if(currentYun.liuNianGanZhi){
        zhis.push(currentYun.liuNianGanZhi.substr(1));
      }
    }

    var matched=[];
    var gxs = {};
    var size=zhis.length;
        for(var i=0;i<size;i++){
          for(var j=0;j<size;j++){
            if(i===j){
              continue;
    }
    var v=tsguanxi[zhis[i]+zhis[j]];
    if(v){
      gxs[v] = true;
        }
      }
    }
    for(var i in gxs){
     matched.push(i);
    }
    s += '<td colspan="10" class="left small">'+(matched.length<1 ? '未犯太岁' : matched.join(' '))+'</td>';
    s += '</tr>';

    s += '<tr>';
    s += '<td>婚配：</td>';	
    var hunpei = {
	'子':'宜 (子丑合 申子合 子辰合)  忌 (子午冲 子卯刑 子未害 子酉破)',
	'丑':'宜 (子丑合 酉丑合)  忌 (丑未冲 丑戌未刑 丑午害 辰丑破)',
	'寅':'宜 (寅亥合<破> 寅午合)  忌 (寅申冲 寅巳申刑 寅巳害)',
	'卯':'宜 (卯戌合 亥卯合 卯未合)  忌 (卯酉冲 子卯刑 卯辰害 卯午破)',
	'辰':'宜 (辰酉合 子辰合)  忌 (辰戌冲 辰辰刑 卯辰害 辰丑破)',
	'巳':'宜 (巳申合 巳酉合)  忌 (巳亥冲 寅巳申刑 寅巳害 巳申破)',
	'午':'宜 (午未合 寅午合 午戌合)  忌 (子午冲 午午刑 丑午害 卯午破)',
	'未':'宜 (午未合 卯未)  忌 (丑未冲 丑戌未刑 子未害 未戌破)',
	'申':'宜 (巳申合<破> 申子合)  忌 (寅申冲 寅巳申刑 申亥害)',
	'酉':'宜 (辰酉合 巳酉合 酉丑合)  忌 (卯酉冲 酉酉刑 酉戌害 子酉破)',
	'戌':'宜 (卯戌合 午戌合)  忌 (辰戌冲 丑戌未刑 酉戌害 未戌破)',
	'亥':'宜 (寅亥合<破> 亥卯合)  忌 (巳亥冲 亥亥刑 申亥害)'
    };
    var yearZhi = bazi.getYearZhi();
    var hp = '';
    for(var i in hunpei){
        if(i.indexOf(yearZhi )>-1){
            hp = hunpei[i];
            break;
        }
    }
    s += '<td colspan="10" class="left small">' + hp +'</td>';
    s += '</tr>';
    
    // 2 end>
    
    if(-1!=gender){

      s += '<tr>';
      s += '<td>三垣：</td>';
      s += '<td colspan="10" class="left small">' + '胎元 ' + bazi.getTaiYuan() + '(' + bazi.getTaiYuanNaYin() + ')' + '；命宫 '+ bazi.getMingGong() + '(' + bazi.getMingGongNaYin() + ')' + '；身宫 '+ bazi.getShenGong() + '(' + bazi.getShenGongNaYin() + ')' + '</td>';
      s += '</tr>';

      s += '<tr>';
      s += '<td>起运：</td>';
      s += '<td colspan="10" class="left small">'+startYunSolar.getYear()+'年'+startYunSolar.getMonth()+'月'+startYunSolar.getDay()+'日</td>';
      s += '</tr>';
      
      s += '<tr>';
      s += '<td>周岁：</td>';
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        s += '<td'+(i>=daYunSize-2?' class="hide"':'')+'>' + d.getStartAge() + '</td>';
      }
      s += '</tr>';
      s += '<tr>';
      s += '<td>换运：</td>';
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        s += '<td'+(i>=daYunSize-2?' class="hide"':'')+'>' + d.getStartYear() + '</td>';
      }
      s += '</tr>';
      s += '<tr>';
      s += '<td>十神：</td>';
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        var shiShen = LunarUtil.SHI_SHEN_GAN[bazi.getDayGan() + d.getGanZhi().substr(0,1)];
        s += '<td class="small'+(i>=daYunSize-2?' hide':'')+'">' + (shiShen ? shiShen:'') + '</td>';
      }
      s += '</tr>';
      s += '<tr>';
      s += '<td>大运：</td>';
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        var ganZhi = d.getGanZhi();
        if(!ganZhi){
          s += '<td class="red">童限</td>';
        }else{
          s += '<td class="bold'+(d.getStartYear()<=currentYear&&currentYear<=d.getEndYear()?' red':'')+(i>=daYunSize-2?' hide':'')+'">' + ganZhi + '</td>';
        }
      }
      s += '</tr>';
      s += '<tr>';
      s += '<td valign="top">流年：</td>';
      for(var i=0;i<daYunSize;i++){
        var d = daYun[i];
        var liuNian = d.getLiuNian();
        s += '<td valign="top"'+(i>=daYunSize-2?' class="hide"':'')+'>';
        for(var x=0,y=liuNian.length;x<y;x++){
          var n = liuNian[x];
          s += '<div'+(n.getYear()==currentYear?' class="red"':'')+'>'+n.getGanZhi() + '</div>';
        }
        s += '</td>';
      }
      s += '</tr>';



    }
    
    s += '</tbody></table>';
    result.innerHTML = s;
  };
  
  var computeLunar = function(year,month,day,hour,minute,gender){
    var lunar = Lunar.fromYmdHms(year,month,day,hour,minute,0);
    var solar = lunar.getSolar();
    computeEightChar(lunar,solar,gender);
  };
  
  var computeSolar = function(year,month,day,hour,minute,gender){
    var solar = Solar.fromYmdHms(year,month,day,hour,minute,0);
    var lunar = solar.getLunar();
    computeEightChar(lunar,solar,gender);
  };
  
  var compute = function(){
    result.innerHTML = '';
    var v = trim(input.value);
    if(lunarCheck.checked){
      var year = parseInt(v.substr(0,4));
      v = v.substr(4);
      var leapMonth = false;
      if(v.indexOf(' ') == 0){
        leapMonth = true;
      }
      v = trim(v);
      var month = parseInt(v.substr(0,2),10);
      if(leapMonth){
        if(LunarUtil.getLeapMonth(year)==month){
          month = -month;
        }
      }
      
      v = trim(v.substr(2));
      var day = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var hour = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var minute = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var gender = -1;
      if('+'==v){
        gender = 1;
      }else if('-'==v){
        gender = 0;
      }
      if(year<1901||year>2099){
        return;
      }
      if(month>=0&&(month<1||month>12)){
        return;
      }
      if(month<0&&(month<-12||month>-1)){
        return;
      }
      if(day<1||day>30){
        return;
      }
      if(hour<0||hour>23){
        return;
      }
      if(minute<0||minute>59){
        return;
      }
      computeLunar(year,month,day,hour,minute,gender);
    }else{
      var year = parseInt(v.substr(0,4));
      v = trim(v.substr(4));
      var month = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var day = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var hour = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var minute = parseInt(v.substr(0,2),10);
      v = trim(v.substr(2));
      var gender = -1;
      if('+'==v){
        gender = 1;
      }else if('-'==v){
        gender = 0;
      }
      if(year<1901||year>2099){
        return;
      }
      if(month<1||month>12){
        return;
      }
      if(day<1||day>31){
        return;
      }
      if(hour<0||hour>23){
        return;
      }
      if(minute<0||minute>59){
        return;
      }
      computeSolar(year,month,day,hour,minute,gender);
    }
  };
  
  input.oninput = onInput;
  input.onpropertychange = onInput;
  genderMan.onclick = onChangeGender;
  genderWoman.onclick = onChangeGender;
  lunarCheck.onclick = onChangeLunar;
})(window,document);
</script>
</body>
</html>
